[Net.ServicePointManager]::SecurityProtocol = "tls12, tls11"

# Fetch malware domain lists
Invoke-WebRequest "https://ransomwaretracker.abuse.ch/downloads/RW_DOMBL.txt" -OutFile "ransomwaretracker.txt"
Invoke-WebRequest "https://www.dshield.org/feeds/suspiciousdomains_Low.txt" -OutFile "dshield.txt"
Invoke-WebRequest "http://mirror1.malwaredomains.com/files/domains.txt" -OutFile "malwaredomains.txt"

# Parsing files - removing comments and selecting the right column
$domains = Get-Content malwaredomains.txt | Where-Object {$_ -notmatch "^#"} | %{ $_.Split([char]9)[2] }
$domains += Get-Content ransomwaretracker.txt,dshield.txt | Where-Object {$_ -notmatch "^#"} 

# Populating Windows hosts file
$hosts = "$env:windir\System32\drivers\etc\hosts"
ForEach ($domain in $domains) {  # Get-Content domains.txt | ForEach-Object {
  "127.0.0.1    $domain" | Add-Content $hosts
}

# Fetch IP blacklists
Invoke-WebRequest "https://iplists.firehol.org/files/firehol_level1.netset" -OutFile "level1.txt"
Invoke-WebRequest "https://iplists.firehol.org/files/firehol_webclient.netset" -OutFile "webclient.txt"

# Generate firewall rules for each one
Get-Content level1.txt,webclient.txt | Where-Object {$_ -notmatch "^#|10.0.0.0|192.168.0.0|172.16.0.0|100.64.0.0"} | ForEach-Object {
  New-NetFirewallRule -Name "Malicious_$_" -DisplayName "Malicious_$_" -Enabled 1 -Direction Outbound -Action Block -Protocol TCP -RemoteAddress $_
}

# cleaning up
ForEach ($file in “ransomwaretracker.txt”,”dshield.txt”,”malwaredomains.txt”,”level1.txt”,”webclient.txt”) {
  Remove-Item $file 
}
